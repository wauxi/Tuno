(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=t(r);fetch(r.href,n)}})();class Y{constructor(){this.navLinks=document.querySelectorAll(".info__navbar a"),this.init()}init(){const e=window.location.pathname;this.navLinks.forEach(t=>{t.getAttribute("href")===e&&t.classList.add("button--active"),t.addEventListener("click",s=>{t.getAttribute("href")===window.location.pathname&&(s.preventDefault(),console.log("–í—ã —É–∂–µ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ!"))})})}}const G={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_DEV_SERVER_PORT:"5173"},R=typeof import.meta<"u"&&import.meta&&G?G:{},D=a=>{const e=`VITE_${a}`;return Object.prototype.hasOwnProperty.call(R,e)?R[e]:Object.prototype.hasOwnProperty.call(R,a)?R[a]:null},F=a=>{const e=typeof document<"u"?document.querySelector(`meta[name="${a}"]`):null;return e?e.getAttribute("content"):D(a.replace(/-/g,"_").toUpperCase())},f={DEVELOPMENT:"development",PRODUCTION:"production",STAGING:"staging",TEST:"test"},X=()=>{const a=F("app-env")||D("APP_ENV");if(a&&Object.values(f).includes(a))return a;const e=window.location.hostname;return e==="localhost"||e==="127.0.0.1"||e==="ms2"?f.DEVELOPMENT:e.includes("staging")||e.includes("stage")?f.STAGING:e.includes("test")?f.TEST:f.PRODUCTION},b=X(),U=F("api-base-url")||D("API_BASE_URL"),Q={[f.DEVELOPMENT]:{API_BASE_URL:U||"http://localhost:8080",DEBUG_MODE:!0,ENABLE_LOGGING:!0},[f.STAGING]:{API_BASE_URL:U||"/",DEBUG_MODE:!0,ENABLE_LOGGING:!0},[f.PRODUCTION]:{API_BASE_URL:U||"/",DEBUG_MODE:!1,ENABLE_LOGGING:!1},[f.TEST]:{API_BASE_URL:U||"http://localhost:8000",DEBUG_MODE:!0,ENABLE_LOGGING:!0}},_={CURRENT:b,IS_DEV:b===f.DEVELOPMENT,IS_PROD:b===f.PRODUCTION,...Q[b]},E={API_REQUEST:3e4,ELEMENT_WAIT:1e4,SEARCH_DEBOUNCE:300,ANIMATION:300,MODAL_SHOW:10,INIT_DELAY:100,NOTIFICATION:5e3,RATING_LOAD:100},Z={USER_DATA_TTL:36e5},m={DEBUG:0,INFO:1,WARN:2,ERROR:3};class ee{constructor(){this.level=_.DEBUG_MODE?m.DEBUG:m.WARN}setLevel(e){this.level=e}debug(e,...t){this.level<=m.DEBUG&&console.debug("[DEBUG]",e,...t)}info(e,...t){this.level<=m.INFO&&console.info("[INFO]",e,...t)}success(e,...t){this.level<=m.INFO&&console.log("%c[SUCCESS]","color: #22c55e",e,...t)}warn(e,...t){this.level<=m.WARN&&console.warn("[WARN]",e,...t)}error(e,...t){this.level<=m.ERROR&&console.error("[ERROR]",e,...t)}api(e,t,s=null){this.level<=m.DEBUG&&(console.groupCollapsed(`%c[API] ${e} ${t}`,"color: #3b82f6"),s&&console.log("Data:",s),console.trace("Called from:"),console.groupEnd())}perf(e,t){this.level<=m.DEBUG&&console.log(`%c[PERF] ${e}`,"color: #f59e0b",`${t.toFixed(2)}ms`)}group(e){this.level<=m.DEBUG&&console.group(e)}groupEnd(){this.level<=m.DEBUG&&console.groupEnd()}table(e){this.level<=m.DEBUG&&console.table(e)}}const l=new ee,N={TTL:{USER_DATA:36e5,ALBUM_COVERS:2592e6,SEARCH_RESULTS:3e5},PREFIX:{USER:"user_",COVERS:"covers_",SEARCH:"search_",TIMESTAMP:"ts_"}};class te{constructor(){this.storage=localStorage}set(e,t,s=N.TTL.USER_DATA){try{const r={value:t,timestamp:Date.now(),ttl:s};return this.storage.setItem(e,JSON.stringify(r)),!0}catch(r){return l.error(`Cache set error for key ${e}:`,r),!1}}get(e){try{const t=this.storage.getItem(e);if(!t)return null;const s=JSON.parse(t);return Date.now()-s.timestamp>s.ttl?(this.delete(e),null):s.value}catch(t){return l.error(`Cache get error for key ${e}:`,t),null}}has(e){return this.get(e)!==null}delete(e){try{return this.storage.removeItem(e),!0}catch(t){return l.error(`Cache delete error for key ${e}:`,t),!1}}clearByPrefix(e){try{return Object.keys(this.storage).forEach(s=>{s.startsWith(e)&&this.storage.removeItem(s)}),!0}catch(t){return l.error("Cache clear by prefix error:",t),!1}}invalidateUserCache(e){const t=`${N.PREFIX.USER}${e}_`;return this.clearByPrefix(t)}getSize(){let e=0;for(let t in this.storage)this.storage.hasOwnProperty(t)&&(e+=this.storage[t].length+t.length);return e}getSizeFormatted(){const e=this.getSize();return e<1024?e+" B":e<1048576?(e/1024).toFixed(2)+" KB":(e/1048576).toFixed(2)+" MB"}}const se=new te,c={API:{BASE_URL:_.API_BASE_URL,ENDPOINTS:{MAIN:"index.php",AUTH:"api/auth.php",RATINGS:"api/ratings.php",USERS:"api/users.php",COVERS:"api/covers.php"},TIMEOUT:E.API_REQUEST},CACHE:{LIFETIME:Z.USER_DATA_TTL,KEYS:{RECENT_ACTIVITY:"recentActivity",LISTEN_LATER:"listenLater",ALBUMS:"albums",CURRENT_USER:"currentUser",CURRENT_USER_ID:"currentUserId"}},DEFAULTS:{USER_ID:4,GUEST_USER_ID:1,ITEMS_PER_PAGE:20,COVER_PLACEHOLDER:"img/default-cover.png"},UI:{SEARCH_DEBOUNCE:E.SEARCH_DEBOUNCE,ANIMATION_DURATION:E.ANIMATION,MODAL_SHOW_DELAY:E.MODAL_SHOW,INIT_DELAY:E.INIT_DELAY,NOTIFICATION_DURATION:E.NOTIFICATION,RATING_LOAD_DELAY:E.RATING_LOAD},ROUTES:{HOME:"/index.html",LOGIN:"/public/pages/login.html",SIGNUP:"/public/pages/login.html?mode=register"},ROLES:{ADMIN:"admin",USER:"user",GUEST:"guest"},RATING:{MIN:0,MAX:10,STARS:5,HALF_STAR_ENABLED:!0},IMAGES:{PLACEHOLDER:"https://via.placeholder.com/150x150/333/666?text=No+Image",FALLBACK:"img/default-cover.png"},FEATURES:{ENABLE_SEARCH:!0,ENABLE_CACHE:!0,ENABLE_NOTIFICATIONS:!0,DEBUG_MODE:_.DEBUG_MODE}},{DEFAULTS:T,UI:L,ROUTES:S,IMAGES:M}=c,u={NETWORK:"NETWORK_ERROR",API:"API_ERROR",VALIDATION:"VALIDATION_ERROR",AUTH:"AUTH_ERROR",NOT_FOUND:"NOT_FOUND",PERMISSION:"PERMISSION_ERROR",TIMEOUT:"TIMEOUT_ERROR",SERVER:"SERVER_ERROR",UNKNOWN:"UNKNOWN_ERROR"},H={[u.NETWORK]:"No internet connection. Please check your network.",[u.AUTH]:"Authentication required. Please log in.",[u.NOT_FOUND]:"The requested resource was not found.",[u.PERMISSION]:"You don't have permission to perform this action.",[u.TIMEOUT]:"Request timed out. Please try again.",[u.SERVER]:"Server error. Our team has been notified.",[u.VALIDATION]:"Please check your input and try again.",[u.UNKNOWN]:"Something went wrong. Please try again."};class x extends Error{constructor(e,t,s={},r=null){super(t),this.name="AppError",this.type=e,this.context=s,this.originalError=r,this.timestamp=new Date().toISOString(),this.userMessage=H[e]||H[u.UNKNOWN]}}class re{constructor(){this.listeners=[],this.sentryInitialized=!1}classifyError(e,t=null){if(!navigator.onLine)return u.NETWORK;if(t){if(t===401)return u.AUTH;if(t===403)return u.PERMISSION;if(t===404)return u.NOT_FOUND;if(t===408)return u.TIMEOUT;if(t>=500)return u.SERVER}return e.name==="AbortError"||e.message.includes("timeout")?u.TIMEOUT:e.message.includes("Failed to fetch")||e.message.includes("NetworkError")?u.NETWORK:u.API}handleApiError(e,t={}){const s=e.response?.status||t.statusCode,r=this.classifyError(e,s),n=new x(r,e.message,{...t,statusCode:s,url:t.url,method:t.method,userId:this.getUserContext()},e);return this.logError(n),this.notifyUser(n.userMessage,"error"),this.reportToMonitoring(n),n}handleValidationError(e,t=null){const s=new x(u.VALIDATION,e,{field:t});return this.logError(s),s}logError(e){e.type,e.message,e.context,e.timestamp,e.stack,_.DEBUG_MODE?(console.group(`%c‚ùå ${e.type}`,"color: #ff4444; font-weight: bold"),console.error("Message:",e.message),console.error("Context:",e.context),console.error("Stack:",e.stack),console.groupEnd()):console.error(`[${e.type}]`,e.message),this.listeners.forEach(t=>t(e))}notifyUser(e,t="error"){window.dispatchEvent(new CustomEvent("app:notification",{detail:{message:e,type:t}}))}reportToMonitoring(e){_.IS_PROD&&typeof Sentry<"u"&&this.sentryInitialized&&Sentry.captureException(e.originalError||e,{tags:{errorType:e.type},contexts:{custom:e.context}})}getUserContext(){try{const e=localStorage.getItem("currentUser");return e?JSON.parse(e).id:"anonymous"}catch{return"anonymous"}}initSentry(e){typeof Sentry<"u"&&(Sentry.init({dsn:e,environment:_.CURRENT,beforeSend(t){return _.IS_DEV?null:t}}),this.sentryInitialized=!0)}onError(e){this.listeners.push(e)}clearListeners(){this.listeners=[]}}const w=new re;window.addEventListener("error",a=>{w.handleApiError(a.error,{filename:a.filename,line:a.lineno,column:a.colno})});window.addEventListener("unhandledrejection",a=>{w.handleApiError(a.reason,{type:"unhandled_promise_rejection"})});class ne{constructor({apiUrl:e,userId:t}){this.apiUrl=e||`${c.API.BASE_URL}/${c.API.ENDPOINTS.MAIN}`,this.userId=t,this.cacheManager=se,this.cacheKey=`user_${t}_data`,this.data={recentActivity:null,listenLater:null,albums:null}}async fetchFromApi(e=0){try{const s=this.userId?`${this.apiUrl}?user_id=${this.userId}`:this.apiUrl,r=await fetch(s,{method:"GET",headers:{"Content-Type":"application/json"},cache:"no-cache",signal:AbortSignal.timeout(c.API.TIMEOUT)});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);return await r.json()}catch(s){if(await w.handleApiError(s,{url:this.apiUrl,userId:this.userId,attempt:e+1}),e<3){const r=Math.min(1e3*Math.pow(2,e),5e3);return l.info(`Retrying in ${r}ms...`),await new Promise(n=>setTimeout(n,r)),this.fetchFromApi(e+1)}throw s}}async loadData(e=!1){try{if(!e){const s=this.cacheManager.get(this.cacheKey);if(s)return this.data=s,!this.data.recentActivity||this.data.recentActivity.length===0?this.loadData(!0):(l.info("Data loaded from cache"),this.data)}l.info("Loading data from server...");const t=await this.fetchFromApi();if(t&&t.success)return this.data.recentActivity=t.recentActivity||[],this.data.listenLater=t.listenLater||[],this.data.albums=t.albums||[],this.cacheManager.set(this.cacheKey,this.data,N.TTL.USER_DATA),l.success("Data loaded and cached"),this.data;throw new Error("Server returned invalid data")}catch(t){await w.handleApiError(t,{userId:this.userId,forceRefresh:e});const s=localStorage.getItem(this.cacheKey);if(s)try{const r=JSON.parse(s);return this.data=r.value,l.warn("Using stale cache due to error"),w.notifyUser("Using cached data","warning"),this.data}catch(r){l.error("Failed to parse stale cache:",r)}return this.data={recentActivity:[],listenLater:[],albums:[]},this.data}}clearCache(){return this.cacheManager.invalidateUserCache(this.userId)}}class O{static generateStarRating(e,t=!0){const s=e/2;if(s===0)return'<span class="no-rating">–ù–µ—Ç –æ—Ü–µ–Ω–∫–∏</span>';let r="";for(let n=1;n<=5;n++)n<=Math.floor(s)?r+='<span class="star star--full">‚òÖ</span>':t&&n<=s+.5?r+=`<span class="star star--half">
                    <span class="star-half-bg">‚òÖ</span>
                    <span class="star-half-fill">‚òÖ</span>
                </span>`:r+='<span class="star star--empty">‚òÖ</span>';return r}static generateInteractiveStarRating(e){const t=e?e/2:0;let s="";for(let r=1;r<=5;r++)r<=Math.floor(t)?s+=`<span class="rating-star rating-star--selected" data-value="${r}">‚òÖ</span>`:r<=t+.5?s+=`<span class="rating-star rating-star--half" data-value="${r}">‚òÖ</span>`:s+=`<span class="rating-star rating-star--unselected" data-value="${r}">‚òÖ</span>`;return s}static fiveStarToTenScale(e){return e*2}static tenScaleToFiveStar(e){return e/2}}class B{constructor({container:e,dataType:t,dataService:s,template:r="album-item"}){this.container=e,this.dataType=t,this.dataService=s,this.template=r}render(){if(!this.container)return;const e=this.dataService.data[this.dataType];if(!e)return;if(!Array.isArray(e)||e.length===0){this.container.innerHTML=`
                <li class="empty-state">
                    <div class="empty-state-content">
                        <span class="empty-state-icon">üéµ</span>
                        <p class="empty-state-text">
                            ${this.dataType==="recentActivity"?"–ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π":"–°–ø–∏—Å–æ–∫ –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –ø—É—Å—Ç"}
                        </p>
                    </div>
                </li>
            `;return}let t="";for(const s of e)this.template==="listen-later-item"?t+=this.getListenLaterTemplate(s):t+=this.getAlbumTemplate(s);this.container.innerHTML=t}getAlbumTemplate(e){return this.getTemplate(e,{itemClass:"recently__item",coverClass:"recently__cover",menuActions:[{action:"write-review",icon:"‚úçÔ∏è",label:e.rating?"Edit review":"Write review",class:"write"},{action:"go-to-album",icon:"üéµ",label:"Go to album",class:"spotify"}]})}getListenLaterTemplate(e){return this.getTemplate(e,{itemClass:"listen-later__item",coverClass:"listen-later__cover",coverSize:"50x50",menuPosition:"side",menuActions:[{action:"write-review",icon:"‚úçÔ∏è",label:"Write review",class:"write"},{action:"remove-listen-later",icon:"‚ùå",label:"Remove from Listen Later",class:"remove"},{action:"go-to-album",icon:"üéµ",label:"Go to album",class:"spotify"}]})}getTemplate(e,t){const{itemClass:s,coverClass:r,coverSize:n="150x150",menuPosition:i="",menuActions:d=[]}=t,o=this.getCoverUrl(e),g=e.album_name||e.albumName||"Unknown Album",h=e.artist||"Unknown Artist",y=e.rating||0,A=e.album_id||e.id||0,I=e.spotify_link||"",j={rating:e.rating||0,rating_id:e.rating_id||null,album_id:A},C=y?O.generateStarRating(y,!0):"",$=M.PLACEHOLDER,P=i?`album-menu album-menu--${i}`:"album-menu",k=d.map(({action:W,icon:z,label:K,class:J})=>`<button class="album-menu__item album-menu__item--${J}" data-action="${W}">
                <span class="album-menu__icon">${z}</span>
                ${K}
            </button>`).join("");return`
            <li class="${s}" 
                data-album-id="${A}" 
                data-spotify-link="${I}"
                ${y?`data-rating-data='${JSON.stringify(j)}'`:""}>
                ${s==="recently__item"?`
                <div class="recently__cover-container">
                    <img src="${o}" 
                        alt="${g}" 
                        class="${r}" 
                        loading="lazy"
                        decoding="async"
                        onerror="this.src='${$}'"
                        onload="this.classList.add('loaded')">
                    <div class="${P}">
                        <button class="album-menu__trigger" type="button">
                            <span class="album-menu__dots"></span>
                        </button>
                        <div class="album-menu__dropdown">
                            ${k}
                        </div>
                    </div>
                </div>
                <div class="recently__info">
                    <h3 class="recently__album">${g}</h3>
                    <p class="recently__artist">${h}</p>
                    ${C?`<div class="recently__rating">${C}</div>`:""}
                </div>
                `:`
                <img src="${o}" 
                    alt="${g}" 
                    class="${r}" 
                    loading="lazy"
                    decoding="async"
                    onerror="this.src='${$}'"
                    onload="this.classList.add('loaded')">
                <div class="listen-later__info">
                    <h3 class="listen-later__album">${g}</h3>
                    <p class="listen-later__artist">${h}</p>
                </div>
                <div class="${P}">
                    <button class="album-menu__trigger" type="button">
                        <span class="album-menu__dots"></span>
                    </button>
                    <div class="album-menu__dropdown">
                        ${k}
                    </div>
                </div>
                `}
            </li>
        `}getCoverUrl(e){return e.coverUrl||e.cover_url||e.cover||M.FALLBACK}}class ae{constructor(){this.events={}}on(e,t){return this.events[e]||(this.events[e]=[]),this.events[e].push(t),()=>this.off(e,t)}once(e,t){const s=r=>{t(r),this.off(e,s)};this.on(e,s)}off(e,t){this.events[e]&&(this.events[e]=this.events[e].filter(s=>s!==t),this.events[e].length===0&&delete this.events[e])}emit(e,t){this.events[e]&&this.events[e].forEach(s=>{try{s(t)}catch(r){console.error(`Error in event handler for "${e}":`,r)}})}clear(e){e?delete this.events[e]:this.events={}}getEvents(){return Object.keys(this.events)}getListenerCount(e){return this.events[e]?.length||0}}const p=new ae,v={USER_LOGIN:"user:login",USER_LOGOUT:"user:logout",USER_SWITCH:"user:switch",USER_UPDATED:"user:updated",RATING_ADDED:"rating:added",RATING_UPDATED:"rating:updated",RATING_DELETED:"rating:deleted",RATINGS_LOADED:"ratings:loaded",ALBUM_ADDED:"album:added",ALBUM_REMOVED:"album:removed",ALBUM_UPDATED:"album:updated",MODAL_OPENED:"modal:opened",MODAL_CLOSED:"modal:closed",SEARCH_QUERY:"search:query",SEARCH_RESULTS:"search:results",DATA_LOADED:"data:loaded",DATA_ERROR:"data:error",CLEAR_CACHE:"data:clear_cache",NAVIGATE:"navigate",ROUTE_CHANGED:"route:changed"},V=()=>{const a=localStorage.getItem("currentUserId");return a?parseInt(a,10):T.USER_ID},q=a=>{localStorage.setItem("currentUserId",a.toString())},ie=()=>{const a=localStorage.getItem("currentUser");if(!a||a==="null")return null;try{return JSON.parse(a)}catch(e){return console.error("Failed to parse user data:",e),localStorage.removeItem("currentUser"),null}},oe=()=>{localStorage.removeItem("currentUser"),localStorage.removeItem("currentUserId")},le=()=>{const a=localStorage.getItem("currentUser");return a&&a!=="null"};class ce{constructor(){this.apiUrl=`${c.API.BASE_URL}/${c.API.ENDPOINTS.RATINGS}`,this.currentUserId=V()}async addRating(e,t){try{const r=await(await fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({album_id:e,user_id:this.currentUserId,...t})})).json();if(!r.success)throw new Error(r.message);return r}catch(s){throw l.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏:",s),s}}async updateRating(e,t){try{const r=await(await fetch(this.apiUrl,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({rating_id:e,...t})})).json();if(!r.success)throw new Error(r.message);return r}catch(s){throw l.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏:",s),s}}async deleteRating(e){try{const s=await(await fetch(this.apiUrl,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({rating_id:e})})).json();if(!s.success)throw new Error(s.message);return s}catch(t){throw l.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏:",t),t}}async getRating(e,t=null){try{const s=t||this.currentUserId;return await(await fetch(`${this.apiUrl}?album_id=${e}&user_id=${s}`)).json()}catch(s){throw l.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏:",s),s}}isUserLoggedIn(){return le()}generateStarRating(e){return O.generateStarRating(e,!1)}generateInteractiveStarRating(e){return O.generateInteractiveStarRating(e)}async showRatingModalComponent(e,t){const s=document.createElement("rating-modal");if(s.setAttribute("album-id",e.id),s.setAttribute("album-name",e.album_name),s.setAttribute("artist",e.artist),s.setAttribute("cover-url",e.coverUrl||""),s.addEventListener("save",async r=>{const{ratingData:n,existingRating:i}=r.detail;await this.handleSave(n,i||t)}),s.addEventListener("delete",async r=>{await this.handleDelete(t)}),document.body.appendChild(s),t){await new Promise(r=>requestAnimationFrame(r)),await new Promise(r=>requestAnimationFrame(r));try{typeof s.setRating=="function"&&s.setRating(t)}catch(r){l.warn("Failed to set rating on modal:",r)}}}async handleSave(e,t){try{t?.id?await this.updateRating(t.id,e):await this.addRating(e.album_id,e),p.emit(v.RATING_UPDATED,{ratingData:e,existingRating:t,shouldReload:!0})}catch(s){l.error("Error saving rating:",s),alert("Error saving rating: "+s.message)}}async handleDelete(e){if(e?.id)try{await this.deleteRating(e.id),p.emit(v.RATING_DELETED,{ratingId:e.id,albumId:e.album_id,shouldReload:!0})}catch(t){l.error("Error deleting rating:",t),alert("Error deleting rating: "+t.message)}}}class ue{constructor(e){this.ratingManager=e,this.searchInput=null,this.searchContainer=null,this.searchResults=null,this.searchTimeout=null,this.searchModal=null,this.searchModalInput=null,this.searchModalResults=null,this.isMobile=window.innerWidth<=580,this.init(),this.setupResizeListener()}setupResizeListener(){window.addEventListener("resize",()=>{this.isMobile=window.innerWidth<=580})}init(){this.searchInput=document.querySelector(".navigation__search-input"),this.searchContainer=document.querySelector(".navigation__search"),this.searchModal=document.querySelector(".search-modal"),this.searchModalInput=document.querySelector(".search-modal__input"),this.searchModalResults=document.querySelector(".search-modal__results"),this.searchInput&&this.searchContainer&&(this.createSearchResults(),this.bindEvents()),this.searchModal&&this.bindModalEvents()}bindModalEvents(){const e=this.searchModal.querySelector(".search-modal__close"),t=this.searchModal.querySelector(".search-modal__overlay");this.searchContainer.addEventListener("click",s=>{this.isMobile&&!s.target.closest(".navigation__search-input")&&this.openModal()}),e?.addEventListener("click",()=>this.closeModal()),t?.addEventListener("click",()=>this.closeModal()),this.searchModalInput?.addEventListener("input",s=>{const r=s.target.value.trim();if(this.searchTimeout&&clearTimeout(this.searchTimeout),r.length<2){this.searchModalResults.innerHTML="";return}this.searchTimeout=setTimeout(()=>{this.performModalSearch(r)},L.SEARCH_DEBOUNCE)}),document.addEventListener("keydown",s=>{s.key==="Escape"&&this.searchModal?.classList.contains("active")&&this.closeModal()})}openModal(){this.searchModal&&(this.searchModal.classList.add("active"),this.searchModal.style.display="block",document.body.style.overflow="hidden",setTimeout(()=>{this.searchModalInput?.focus()},100))}closeModal(){this.searchModal&&(this.searchModal.classList.remove("active"),this.searchModal.style.display="none",document.body.style.overflow="",this.searchModalInput&&(this.searchModalInput.value=""),this.searchModalResults&&(this.searchModalResults.innerHTML=""))}createSearchResults(){this.searchResults=document.createElement("div"),this.searchResults.className="search-results",this.searchResults.style.display="none",this.searchContainer.appendChild(this.searchResults)}bindEvents(){this.searchInput.addEventListener("input",e=>{const t=e.target.value.trim();if(this.searchTimeout&&clearTimeout(this.searchTimeout),t.length<2){this.hideResults();return}this.searchTimeout=setTimeout(()=>{this.performSearch(t)},L.SEARCH_DEBOUNCE)}),document.addEventListener("click",e=>{e.target.closest(".navigation__search")||this.hideResults()}),this.searchInput.addEventListener("focus",()=>{this.searchInput.value.trim().length>=2&&this.showResults()})}async performModalSearch(e){try{const t=`${c.API.BASE_URL}/${c.API.ENDPOINTS.MAIN}?action=search&q=${encodeURIComponent(e)}`,s=await fetch(t);if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const r=await s.json();r.success?this.displayModalResults(r.albums,e):this.showModalError("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: "+(r.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"))}catch{this.showModalError("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è")}}displayModalResults(e,t){if(e.length===0)this.searchModalResults.innerHTML=`
                <div class="search-results__empty">
                    <span class="search-results__icon">üîç</span>
                    <p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–ª—è "${t}"</p>
                </div>
            `;else{const s=e.map(r=>this.getAlbumResultTemplate(r)).join("");this.searchModalResults.innerHTML=`
                <div class="search-results__header">
                    –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ (${e.length})
                </div>
                <div class="search-results__list">
                    ${s}
                </div>
            `,this.bindModalResultEvents()}}bindModalResultEvents(){this.searchModalResults.querySelectorAll(".search-result").forEach(t=>{t.addEventListener("click",()=>{this.handleRateAlbum(t),this.closeModal()})})}showModalError(e){this.searchModalResults&&(this.searchModalResults.innerHTML=`
                <div class="search-results__error">
                    <span class="search-results__icon">‚ö†Ô∏è</span>
                    <p>${e}</p>
                </div>
            `)}async performSearch(e){try{const t=`${c.API.BASE_URL}/${c.API.ENDPOINTS.MAIN}?action=search&q=${encodeURIComponent(e)}`,s=await fetch(t);if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const r=await s.json();r.success?this.displayResults(r.albums,e):this.showError("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: "+(r.error||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"))}catch{this.showError("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è")}}displayResults(e,t){if(e.length===0)this.searchResults.innerHTML=`
                <div class="search-results__empty">
                    <span class="search-results__icon">üîç</span>
                    <p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–ª—è "${t}"</p>
                </div>
            `;else{const s=e.map(r=>this.getAlbumResultTemplate(r)).join("");this.searchResults.innerHTML=`
                <div class="search-results__header">
                    –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ (${e.length})
                </div>
                <div class="search-results__list">
                    ${s}
                </div>
            `,this.bindResultEvents()}this.showResults()}getAlbumResultTemplate(e){const t=JSON.stringify(e).replace(/"/g,"&quot;");return`
            <div class="search-result" data-album-id="${e.album_id}" data-album="${t}">
                <img src="${e.coverUrl}" 
                     alt="${e.album_name}" 
                     class="search-result__cover"
                     onerror="this.src='${M.PLACEHOLDER}'">
                <div class="search-result__info">
                    <h4 class="search-result__album">${e.album_name}</h4>
                    <p class="search-result__artist">${e.artist}</p>
                    ${e.genre?`<span class="search-result__genre">${e.genre}</span>`:""}
                </div>
            </div>
        `}bindResultEvents(){this.searchResults.querySelectorAll(".search-result").forEach(t=>{t.addEventListener("click",()=>{this.handleRateAlbum(t)})})}async handleRateAlbum(e){try{const t=JSON.parse(e.dataset.album.replace(/&quot;/g,'"')),s=V();let r=null;try{const i=await(await fetch(`${c.API.BASE_URL}/${c.API.ENDPOINTS.RATINGS}?album_id=${t.album_id}&user_id=${s}`)).json();r=i.success?i.rating:null}catch{}this.ratingManager.showRatingModalComponent({id:t.album_id,album_name:t.album_name,artist:t.artist,genre:t.genre,spotify_link:t.spotify_link,coverUrl:t.coverUrl},r),this.hideResults(),this.clearSearch()}catch{alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä–º—ã –æ—Ü–µ–Ω–∫–∏")}}showResults(){this.searchResults&&(this.searchResults.style.display="block")}hideResults(){this.searchResults&&(this.searchResults.style.display="none")}showError(e){this.searchResults&&(this.searchResults.innerHTML=`
                <div class="search-results__error">
                    <span class="search-results__icon">‚ö†Ô∏è</span>
                    <p>${e}</p>
                </div>
            `,this.showResults())}clearSearch(){this.searchInput&&(this.searchInput.value="")}}class de{constructor(){this.currentUser=null,this.isLoggedIn=!1}checkAuth(){this.currentUser=ie(),this.isLoggedIn=this.currentUser!==null}async logout(){try{await(await fetch(`${c.API.BASE_URL}/${c.API.ENDPOINTS.AUTH}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"logout"})})).json()}catch(e){l.error("Logout error:",e)}finally{this.currentUser=null,this.isLoggedIn=!1,oe()}}isAdmin(){return this.currentUser&&(this.currentUser.role==="admin"||this.currentUser.isAdmin===!0)}getCurrentUser(){return this.currentUser}isUserLoggedIn(){return this.isLoggedIn}}class he{constructor(){this.usersCache=null}async loadUsers(){try{const e=await fetch(`${c.API.BASE_URL}/${c.API.ENDPOINTS.USERS}`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=e.headers.get("content-type");if(!t||!t.includes("application/json")){const r=await e.text();throw console.error("Response is not JSON:",r.substring(0,200)),new Error("Server returned HTML instead of JSON. Check PHP errors.")}const s=await e.json();s.success&&s.users&&s.users.length>0?this.usersCache=s.users:this.usersCache=[]}catch(e){console.error("Failed to load users:",e),this.usersCache=[]}}getUserById(e){const t=parseInt(e);return this.usersCache&&this.usersCache.length>0?this.usersCache.find(s=>s.id===t):null}getUserNameById(e){const t=this.getUserById(e);return t?t.display_name||t.username:`User ${e}`}getAllUsers(){return this.usersCache||[]}}class ge{constructor(e,t){this.authService=e,this.userService=t,this.viewingUserId=null}setViewingUserId(e){this.viewingUserId=e}updateAuthUI(){const e=document.querySelector(".navigation__auth"),t=document.querySelector(".navigation__user-info"),s=typeof window<"u"&&window.__INITIAL_STATE__?window.__INITIAL_STATE__:null,r=s&&s.currentUser?s.currentUser:this.authService.isUserLoggedIn()?this.authService.getCurrentUser():null;r?(e&&(e.style.display="none"),t&&(t.innerHTML=`
                    <div class="navigation__user-avatar navigation-img">
                        <img src="${r.avatar_url||"/img/logo.jpg"}" alt="User Avatar">
                        <div class="navigation__user-dropdown">
                            <button class="navigation__user-dropdown-item" data-action="view-profile">
                                Profile
                            </button>
                            <button class="navigation__user-dropdown-item" data-action="settings">
                                Settings
                            </button>
                            <button class="navigation__user-dropdown-item navigation__user-dropdown-item--logout" data-action="logout">
                                Log out
                            </button>
                        </div>
                    </div>
                `,t.style.display="flex"),e&&(e.style.display="none")):(t&&(t.style.display="none"),e&&(e.style.display="flex",e.innerHTML=`
                    <button type="button" class="navigation__auth-button button" data-action="login">
                        <span>Login</span>
                    </button>
                    <button type="button" class="navigation__auth-button button" data-action="signup">
                        <span>Sign Up</span>
                    </button>
                `))}updateProfileUI(){const e=document.querySelector(".info__profile-name");if(!e)return;const t=this.userService.getUserNameById(this.viewingUserId),s=this.authService.getCurrentUser(),r=s&&s.id===this.viewingUserId;if(this.authService.isUserLoggedIn()&&s)e.innerHTML=`
                <h5 class="nickname">${t}</h5>
                <h3 class="name">${t}</h3>
                <h4 class="biografy">${r?"–í–∞—à–∞ –º—É–∑—ã–∫–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å":"–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"}</h4>
            `;else{const n=this.getUserSwitcherHTML();e.innerHTML=`
                <h5 class="nickname">${t}</h5>
                <h3 class="name">${t}</h3>
                <h4 class="biografy">
                    –ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    <div class="user-switcher">${n}</div>
                </h4>
            `}}getUserSwitcherHTML(){const e=this.userService.getAllUsers();return!e||e.length===0?"<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>":e.map(t=>{const s=this.viewingUserId===t.id,r=t.display_name||t.username,n=s?"active":"";return`<button data-action="switch-user" data-user-id="${t.id}" class="${n}">${r}</button>`}).join("")}updateUI(){this.updateAuthUI(),this.updateProfileUI()}}class me{constructor(e,t,s){this.authService=e,this.ratingManager=t,this.dataService=s}initAlbumMenus(){document.querySelectorAll(".album-menu").forEach(t=>{const s=t.cloneNode(!0);t.parentNode.replaceChild(s,t),this.attachMenuHandlers(s)})}attachMenuHandlers(e){const t=e.closest("[data-album-id]");if(!t)return;const s=parseInt(t.dataset.albumId),r=e.querySelector(".album-menu__dropdown");if(r){const o=e.querySelector(".album-menu__trigger"),g=e.classList.contains("album-menu--side"),h=()=>{g||requestAnimationFrame(()=>{const y=r.getBoundingClientRect(),A=window.innerWidth,I=10;r.classList.remove("align-left","align-right"),y.left<I?r.classList.add("align-left"):y.right>A-I&&r.classList.add("align-right")})};o&&(o.addEventListener("mouseenter",h),o.addEventListener("focus",h),o.addEventListener("click",h)),e.addEventListener("mouseenter",h),r.addEventListener("transitionend",h)}const n=e.querySelector('[data-action="write-review"]'),i=e.querySelector('[data-action="remove-listen-later"]'),d=e.querySelector('[data-action="go-to-album"]');n&&(this.authService.isUserLoggedIn()?n.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation(),await this.handleWriteReview(s,t)}):n.style.display="none"),i&&(!this.authService.isUserLoggedIn()||!this.authService.isAdmin()?i.style.display="none":i.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation(),await this.handleRemoveFromListenLater(s,t)})),d&&d.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),this.handleGoToAlbum(t)})}async getExistingRating(e){try{const t=this.authService.getCurrentUser();if(!t)return null;const r=await(await fetch(`${c.API.BASE_URL}/${c.API.ENDPOINTS.RATINGS}?album_id=${e}&user_id=${t.id}`)).json();return r.success&&r.rating?r.rating:null}catch(t){return l.error("Error fetching existing rating:",t),null}}async handleWriteReview(e,t){const s=this.extractAlbumData(t,e),r=await this.getExistingRating(e);this.ratingManager.showRatingModalComponent(s,r)}async handleRemoveFromListenLater(e,t){if(!this.authService.isAdmin()){alert("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–ª—å–±–æ–º–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");return}const s=t.querySelector(".listen-later__album, .recently__album")?.textContent||"—ç—Ç–æ—Ç –∞–ª—å–±–æ–º",r=t.querySelector(".listen-later__artist, .recently__artist")?.textContent||"",n=r?`${r} - ${s}`:s;if(confirm(`‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å "${n}" –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞–≤—Å–µ–≥–¥–∞!

–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`))try{const d=await(await fetch(`${c.API.BASE_URL}/${c.API.ENDPOINTS.MAIN}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"remove_from_listen_later",album_id:e})})).json();if(d.success)t.style.transition=`opacity ${L.ANIMATION_DURATION}ms ease`,t.style.opacity="0",await new Promise(o=>{t.addEventListener("transitionend",o,{once:!0}),setTimeout(o,L.ANIMATION_DURATION+50)}),t.remove(),alert("–ê–ª—å–±–æ–º —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"),this.dataService&&window.location.reload();else throw new Error(d.error||d.message||"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏")}catch(i){i.message.includes("–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏")||i.message.includes("401")?(alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∑–∞–Ω–æ–≤–æ."),window.musicboardApp.logout()):i.message.includes("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")||i.message.includes("403")?alert("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."):alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: "+i.message)}}handleGoToAlbum(e){const t=e.dataset.spotifyLink||e.querySelector("[data-spotify-link]")?.dataset.spotifyLink;if(t)window.open(t,"_blank");else{const s=e.querySelector(".recently__album, .listen-later__album")?.textContent,r=e.querySelector(".recently__artist, .listen-later__artist")?.textContent;if(s&&r){const n=encodeURIComponent(`${r} ${s}`);window.open(`https://open.spotify.com/search/${n}`,"_blank")}else alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å—Å—ã–ª–∫—É –Ω–∞ –∞–ª—å–±–æ–º –≤ Spotify")}}extractAlbumData(e,t){const s=[".album-title",".title",".name","h3","h2","h4",'[class*="title"]','[class*="name"]',".recently__album",".listen-later__album"];let r=null;for(const o of s)if(r=e.querySelector(o),r&&r.textContent.trim())break;const n=[".album-artist",".artist",".performer",".author",'[class*="artist"]','[class*="performer"]',".recently__artist",".listen-later__artist"];let i=null;for(const o of n)if(i=e.querySelector(o),i&&i.textContent.trim())break;const d=e.querySelector("img");return{id:t,album_name:r?r.textContent.trim():"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–ª—å–±–æ–º",artist:i?i.textContent.trim():"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å",coverUrl:d?d.src:c.DEFAULTS.COVER_PLACEHOLDER}}}class pe{constructor(e){this.authService=e,this.isInitialized=!1}initUserMenu(){if(this.isInitialized)return;const e=document.querySelector(".navigation__user-avatar"),t=document.querySelector(".navigation__user-dropdown");!e||!t||(document.addEventListener("click",s=>{const r=s.target.closest(".navigation__user-dropdown-item");r&&(s.preventDefault(),s.stopPropagation(),this.handleMenuItemClick(r))}),document.addEventListener("click",s=>{!e.contains(s.target)&&!t.contains(s.target)&&this.closeDropdown()}),document.addEventListener("keydown",s=>{s.key==="Escape"&&this.closeDropdown()}),this.isInitialized=!0)}handleMenuItemClick(e){const t=e.dataset.action;switch(t){case"view-profile":this.handleViewProfile();break;case"settings":this.handleSettings();break;case"logout":this.handleLogout();break;default:l.warn("Unknown user menu action:",t)}}handleViewProfile(){const e=this.authService.getCurrentUser();e&&(window.location.href=`/${S.HOME}?user_id=${e.id}`)}handleSettings(){l.info("Settings action clicked - navigating to settings page");try{const e=S.SETTINGS||"pages/settings.html";window.location.href=e}catch(e){l.error("Failed to navigate to settings page:",e),window.location.href="pages/settings.html"}}async handleLogout(){try{await this.authService.logout(),window.location.href=`/${S.HOME}`}catch(e){l.error("Error during logout:",e),alert("Error logging out. Please try again.")}}closeDropdown(){document.querySelector(".navigation__user-dropdown")}}class fe extends HTMLElement{constructor(){super(),this.existingRating=null,this.currentRating=0}static get observedAttributes(){return["album-id","album-name","artist","cover-url"]}connectedCallback(){this.render(),this.attachEventListeners(),window.innerWidth<=970&&document.body.classList.add("modal-open"),requestAnimationFrame(()=>{const e=this.querySelector(".rating-modal");e&&e.classList.add("show")})}disconnectedCallback(){this.escapeHandler&&document.removeEventListener("keydown",this.escapeHandler),document.body.classList.remove("modal-open")}attributeChangedCallback(e,t,s){this.querySelector(".rating-modal")&&this.updateAlbumInfo()}render(){const e=this.getAttribute("album-name")||"Unknown Album",t=this.getAttribute("artist")||"Unknown Artist",s=this.getAttribute("cover-url")||M.FALLBACK;this.innerHTML=`
            <div class="rating-modal">
                <div class="rating-modal__overlay"></div>
                <div class="rating-modal__content">
                    <div class="rating-modal__header">
                        <h3>Rate Album</h3>
                        <div class="rating-modal__close">
                            <button class="rating-modal__close-cross" type="button">√ó</button>
                        </div>
                    </div>
                    
                    <div class="rating-modal__body">
                        <div class="rating-modal__left">
                            <div class="album-info__wrapper">
                                <div class="album-info__cover">
                                    <img src="${s}" alt="${e}">
                                </div>
                                <div class="album-info__details">
                                    <h4>${e}</h4>
                                    <p>${t} ‚Ä¢ Album</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="rating-modal__right">
                            <form class="rating-form">
                                <div class="rating-row">
                                    <div class="rating-group">
                                        <h4 class="rating-form__h4">Rating</h4>
                                        <div class="rating-selector">
                                            ${this.generateStars()}
                                        </div>
                                        <input type="hidden" name="rating" value="0">
                                    </div>

                                    <div class="checkbox-group">
                                        <div class="checkbox-section">
                                            <h4 class="rating-form__h4">Must listen</h4>
                                            <label class="checkbox-item">
                                                <input type="checkbox" id="mustListen" name="must_listen">
                                                <span>–í—Å–µ –¥–æ–ª–∂–Ω—ã —ç—Ç–æ –ø–æ—Å–ª—É—à–∞—Ç—å</span>
                                                <div class="checkbox-icon unchecked" data-checkbox="mustListen">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"    
                                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">                                          
                                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>                            
                                                        <polyline points="9 22 9 12 15 12 15 22"></polyline>                 
                                                    </svg>           
                                                </div>
                                            </label>
                                        </div>
                                        <div class="checkbox-section">
                                            <h4 class="rating-form__h4">Would re-listen</h4>
                                            <label class="checkbox-item">
                                                <input type="checkbox" id="wouldRelisten" name="would_relisten">
                                                <span>–ü–µ—Ä–µ—Å–ª—É—à–∞–ª –±—ã</span>
                                                <div class="checkbox-icon unchecked" data-checkbox="wouldRelisten">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="17 1 21 5 17 9"></polyline>
                                                        <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                                                        <polyline points="7 23 3 19 7 15"></polyline>
                                                        <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                                                    </svg>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="date-group">
                                        <h4 class="rating-form__h4" for="listenedAt">Listened at</h4>
                                        <input type="date" id="listenedAt" name="listened_date" value="${this.getTodayDate()}">
                                    </div>
                                </div>

                                <div class="input-group">
                                    <label for="favoriteSong">Favorite Song</label>
                                    <input type="text" id="favoriteSong" name="favorite_song" placeholder="Song title">
                                </div>

                                <div class="input-group">
                                    <label for="leastFavoriteSong">Least Favorite Song</label>
                                    <input type="text" id="leastFavoriteSong" name="least_favorite_song" placeholder="Song title">
                                </div>

                                <div class="input-group">
                                    <label for="review">Review</label>
                                    <textarea id="review" name="review" rows="4" placeholder="Add a review..."></textarea>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="rating-modal__footer">
                        <button type="button" class="btn btn--danger delete-btn" style="display:none;">Delete</button>
                        <button type="button" class="btn btn--primary save-btn">Log Album</button>
                    </div>
                </div>
            </div>
        `}getTodayDate(){const e=new Date,t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${t}-${s}-${r}`}generateStars(){let e="";for(let t=1;t<=5;t++)e+=`<span class="star" data-rating="${t}">‚òÖ</span>`;return e}attachEventListeners(){this.querySelector(".rating-modal__overlay").addEventListener("click",()=>this.close()),this.querySelector(".rating-modal__close-cross").addEventListener("click",()=>this.close()),this.querySelectorAll(".star").forEach(g=>{g.addEventListener("click",h=>this.handleStarClick(h)),g.addEventListener("mousemove",h=>this.handleStarHover(h))}),this.querySelector(".rating-selector").addEventListener("mouseleave",()=>this.resetStars()),this.querySelector(".save-btn").addEventListener("click",()=>this.save()),this.querySelector(".delete-btn").addEventListener("click",()=>this.delete()),this.querySelectorAll(".checkbox-icon").forEach(g=>{g.addEventListener("click",h=>this.handleIconClick(h))}),this.querySelectorAll('input[type="checkbox"]').forEach(g=>{g.addEventListener("change",h=>this.handleCheckboxChange(h))}),this.escapeHandler=g=>{g.key==="Escape"&&this.close()},document.addEventListener("keydown",this.escapeHandler)}handleStarClick(e){const t=e.target,s=parseInt(t.dataset.rating),r=t.getBoundingClientRect(),n=e.clientX-r.left,i=r.width,d=n<i/2;this.currentRating=d?s-.5:s,this.updateStars(this.currentRating);const o=this.querySelector('input[name="rating"]');o.value=this.currentRating*2}handleIconClick(e){const t=e.currentTarget,s=t.dataset.checkbox,r=this.querySelector(`#${s}`);r&&(r.checked=!r.checked,this.updateIconState(t,r.checked))}handleCheckboxChange(e){const t=e.target,s=this.querySelector(`.checkbox-icon[data-checkbox="${t.id}"]`);s&&this.updateIconState(s,t.checked)}updateIconState(e,t){t?(e.classList.remove("unchecked"),e.classList.add("checked")):(e.classList.remove("checked"),e.classList.add("unchecked"))}handleStarHover(e){const t=e.target,s=parseInt(t.dataset.rating),r=t.getBoundingClientRect(),n=e.clientX-r.left,i=r.width,o=n<i/2?s-.5:s;this.updateStars(o)}resetStars(){this.updateStars(this.currentRating)}updateStars(e){const t=this.querySelectorAll(".star"),s=Math.floor(e),r=e%1!==0;t.forEach((n,i)=>{n.classList.remove("filled","half"),i<s?n.classList.add("filled"):i===s&&r&&n.classList.add("half")})}updateAlbumInfo(){const e=this.getAttribute("album-name"),t=this.getAttribute("artist"),s=this.getAttribute("cover-url"),r=this.querySelector(".album-info__details h4"),n=this.querySelector(".album-info__details p"),i=this.querySelector(".album-info__cover img");r&&(r.textContent=e),n&&(n.textContent=`${t} ‚Ä¢ Album`),i&&(i.src=s)}getFormData(){const e=this.querySelector(".rating-form"),t=new FormData(e);return{album_id:parseInt(this.getAttribute("album-id")),rating:parseInt(t.get("rating"))||0,must_listen:t.get("must_listen")==="on"?1:0,would_relisten:t.get("would_relisten")==="on"?1:0,listened_date:t.get("listened_date")||null,favorite_song:t.get("favorite_song")||null,least_favorite_song:t.get("least_favorite_song")||null,review:t.get("review")||null}}save(){const e=this.getFormData();if(e.rating===0){alert("Please select a rating!");return}this.dispatchEvent(new CustomEvent("save",{detail:{ratingData:e,existingRating:this.existingRating},bubbles:!0,composed:!0})),this.close()}delete(){confirm("Are you sure you want to delete this rating?")&&(this.dispatchEvent(new CustomEvent("delete",{detail:this.existingRating,bubbles:!0,composed:!0})),this.close())}close(){const e=this.querySelector(".rating-modal");e&&e.classList.remove("show"),document.removeEventListener("keydown",this.escapeHandler),document.body.classList.remove("modal-open"),this.dispatchEvent(new CustomEvent("close",{bubbles:!0,composed:!0})),e.addEventListener("transitionend",()=>{this.remove()},{once:!0}),setTimeout(()=>this.remove(),350)}setRating(e){if(!e)return;this.existingRating=e;const t=this.querySelector(".rating-form");if(this.querySelectorAll(".star").forEach(r=>{r.classList.remove("filled","half")}),e.rating){const r=e.rating/2;this.currentRating=r,this.updateStars(r),t.querySelector('input[name="rating"]').value=e.rating}if(e.must_listen){const r=t.querySelector('input[name="must_listen"]');r.checked=!0;const n=this.querySelector('.checkbox-icon[data-checkbox="mustListen"]');n&&this.updateIconState(n,!0)}if(e.would_relisten){const r=t.querySelector('input[name="would_relisten"]');r.checked=!0;const n=this.querySelector('.checkbox-icon[data-checkbox="wouldRelisten"]');n&&this.updateIconState(n,!0)}e.listened_date&&(t.querySelector('input[name="listened_date"]').value=e.listened_date),e.favorite_song&&(t.querySelector('input[name="favorite_song"]').value=e.favorite_song),e.least_favorite_song&&(t.querySelector('input[name="least_favorite_song"]').value=e.least_favorite_song),e.review&&(t.querySelector('textarea[name="review"]').value=e.review),this.querySelector(".delete-btn").style.display="block",this.querySelector(".save-btn").textContent="Update Album"}}customElements.define("rating-modal",fe);class ve{constructor(){this.authService=new de,this.userService=new he,this.uiManager=null,this.albumMenuManager=null,this.userMenuManager=null,this.viewingUserId=null,this.dataService=null,this.recentlyGrid=null,this.listenLaterGrid=null,this.ratingManager=null,this.searchManager=null,this.init()}async init(){if(this.authService.checkAuth(),await this.userService.loadUsers(),this.viewingUserId=this.getUserIdFromUrl()||(this.authService.getCurrentUser()?this.authService.getCurrentUser().id:T.USER_ID),this.uiManager=new ge(this.authService,this.userService),this.uiManager.setViewingUserId(this.viewingUserId),this.uiManager.updateUI(),new Y,this.initDataServices(),this.userMenuManager=new pe(this.authService),this.userMenuManager.initUserMenu(),await this.loadData(),this.updateUrl(),this.setupEventDelegation(),this.initRatingSystem(),this.ratingManager){this.searchManager=new ue(this.ratingManager),this.albumMenuManager=new me(this.authService,this.ratingManager,this.dataService);try{await this.waitForElement(".album-menu",E.ELEMENT_WAIT),this.albumMenuManager.initAlbumMenus()}catch{l.warn("Timed out waiting for .album-menu elements, attempting to init menus anyway"),this.albumMenuManager.initAlbumMenus()}}else l.error("RatingManager not found for SearchManager")}setupEventDelegation(){document.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;switch(t.dataset.action){case"logout":e.preventDefault(),this.logout();break;case"login":e.preventDefault(),this.goToLogin();break;case"signup":e.preventDefault(),this.goToSignup();break;case"switch-user":e.preventDefault();const r=parseInt(t.dataset.userId);r&&this.switchUser(r);break}})}isCurrentUserAdmin(){return this.authService.isAdmin()}initDataServices(){this.dataService=new ne({userId:this.viewingUserId}),this.recentlyGrid=new B({container:document.querySelector(".recently__list"),dataType:"recentActivity",dataService:this.dataService}),this.listenLaterGrid=new B({container:document.querySelector(".listen-later__list"),dataType:"listenLater",dataService:this.dataService,template:"listen-later-item"})}initRatingSystem(){this.ratingManager=new ce;const e=this.authService.getCurrentUser();q(e?e.id:this.viewingUserId||T.GUEST_USER_ID),p.on(v.RATING_UPDATED,async t=>{t.shouldReload&&await this.refreshData(),this.albumMenuManager&&this.albumMenuManager.initAlbumMenus()}),p.on(v.RATING_DELETED,async t=>{t.shouldReload&&await this.refreshData()})}async refreshData(){try{await this.dataService.loadData(!0),this.recentlyGrid&&this.recentlyGrid.render(),this.listenLaterGrid&&this.listenLaterGrid.render(),this.albumMenuManager&&this.albumMenuManager.initAlbumMenus(),l.success("Data refreshed successfully without page reload")}catch(e){l.error("Error refreshing data:",e),window.location.reload()}}async loadData(){try{await this.dataService.loadData(!1),this.recentlyGrid&&this.recentlyGrid.render(),this.listenLaterGrid&&this.listenLaterGrid.render()}catch(e){l.error("Error loading data:",e)}}async waitForElement(e,t=E.ELEMENT_WAIT){performance.now();const s=document.querySelector(e);return s||await new Promise((r,n)=>{const i=new MutationObserver(()=>{const o=document.querySelector(e);o&&(i.disconnect(),clearTimeout(d),r(o))});i.observe(document.documentElement||document.body,{childList:!0,subtree:!0});const d=setTimeout(()=>{i.disconnect(),n(new Error(`Element ${e} not found within ${t}ms`))},t)})}getUserIdFromUrl(){const t=new URLSearchParams(window.location.search).get("user");return t?parseInt(t):null}updateUrl(){const e=new URL(window.location);e.searchParams.set("user",this.viewingUserId),window.history.replaceState({},"",e)}switchUser(e){this.authService.isUserLoggedIn()||(window.location.href=`${S.HOME}?user=${e}`)}goToLogin(){window.location.href=S.LOGIN}goToSignup(){window.location.href=S.SIGNUP}async logout(){await this.authService.logout(),this.dataService&&this.dataService.clearCache(),p.emit(v.USER_LOGOUT);const e=this.getUserIdFromUrl()||T.USER_ID;window.location.href=`${S.HOME}?user=${e}`}async refreshRatings(){this.albumMenuManager&&this.albumMenuManager.initAlbumMenus()}}(function(){let a=null;document.addEventListener("DOMContentLoaded",()=>{a=new ve,p.on(v.USER_SWITCH,t=>a?.switchUser(t.userId)),p.on(v.NAVIGATE,t=>{t.route==="login"?a?.goToLogin():t.route==="signup"&&a?.goToSignup()})}),typeof window<"u"&&(Object.defineProperty(window,"musicboardApp",{value:Object.freeze({switchUser:t=>p.emit(v.USER_SWITCH,{userId:t}),goToLogin:()=>p.emit(v.NAVIGATE,{route:"login"}),goToSignup:()=>p.emit(v.NAVIGATE,{route:"signup"}),logout:()=>a?.logout(),refreshRatings:()=>a?.refreshRatings(),getRatingManager:()=>a?.getRatingManager(),getCurrentUser:()=>a?.getCurrentUser(),isCurrentUserAdmin:()=>a?.isCurrentUserAdmin()}),writable:!1,configurable:!1}),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname==="ms2")&&Object.defineProperty(window,"__musicboardDebug",{value:Object.freeze({getAppInstance:()=>a,getEventBus:()=>p,version:"2.0.0"}),writable:!1,configurable:!1}))})();
